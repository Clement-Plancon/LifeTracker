import React, { useState, useEffect } from 'react';
import { AreaChart, Area, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

const themes = {
  dark: { bg:'#0a0b0f', bgSec:'#12131a', bgCard:'rgba(255,255,255,0.03)', border:'rgba(255,255,255,0.08)', text:'#e4e4e7', textSec:'#71717a', textMut:'#52525b', accent:'#6366f1', success:'#10b981', danger:'#ef4444', grad:'linear-gradient(135deg,#6366f1,#8b5cf6)' },
  light: { bg:'#f8fafc', bgSec:'#ffffff', bgCard:'rgba(0,0,0,0.02)', border:'rgba(0,0,0,0.08)', text:'#1e293b', textSec:'#64748b', textMut:'#94a3b8', accent:'#6366f1', success:'#10b981', danger:'#ef4444', grad:'linear-gradient(135deg,#6366f1,#8b5cf6)' }
};

const defActs = {
  running: { name:'Running', icon:'ğŸƒ', color:'#10b981', unit:'km', grad:['#10b981','#059669'] },
  climbing: { name:'Escalade', icon:'ğŸ§—', color:'#f59e0b', unit:'voies', grad:['#f59e0b','#d97706'] },
  gym: { name:'Musculation', icon:'ğŸ‹ï¸', color:'#ef4444', unit:'sÃ©ances', grad:['#ef4444','#dc2626'] },
  english: { name:'Anglais', icon:'ğŸ‡¬ğŸ‡§', color:'#3b82f6', unit:'min', grad:['#3b82f6','#2563eb'] },
  coding: { name:'Dev', icon:'ğŸ’»', color:'#8b5cf6', unit:'heures', grad:['#8b5cf6','#7c3aed'] }
};

const icons = ['ğŸƒ','ğŸ§—','ğŸ‹ï¸','ğŸ‡¬ğŸ‡§','ğŸ’»','ğŸ“š','ğŸ¸','ğŸ¨','ğŸ§˜','ğŸš´','ğŸŠ','âš½','ğŸ¾','ğŸ¥Š','ğŸ¯','âœï¸','ğŸ¹','ğŸ“·','ğŸ§ ','ğŸ’¤'];
const colors = ['#10b981','#f59e0b','#ef4444','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f97316','#84cc16','#06b6d4'];
const avatars = ['ğŸ˜€','ğŸ˜','ğŸ¤“','ğŸ¥³','ğŸ˜‡','ğŸ¤ ','ğŸ¦Š','ğŸ±','ğŸ¶','ğŸ¦','ğŸ¯','ğŸ»','ğŸ¼','ğŸ¦„','ğŸŒ¸','â­'];

const getToday = () => new Date().toISOString().split('T')[0];
const getWeekDates = () => { const t=new Date(),d=t.getDay(),m=new Date(t); m.setDate(t.getDate()-(d===0?6:d-1)); return Array.from({length:7},(_,i)=>{const x=new Date(m);x.setDate(m.getDate()+i);return x.toISOString().split('T')[0]}); };
const fmtDate = d => { const dt=new Date(d),n=new Date(),df=Math.floor((n-dt)/864e5); return df===0?"Aujourd'hui":df===1?"Hier":df<7?`Il y a ${df}j`:dt.toLocaleDateString('fr-FR',{day:'numeric',month:'short'}); };

export default function App() {
  const [dark, setDark] = useState(true);
  const [tab, setTab] = useState('dashboard');
  const [selAct, setSelAct] = useState('running');
  const [mobile, setMobile] = useState(false);
  const [uid, setUid] = useState(null);
  const [users, setUsers] = useState([]);
  const [onboard, setOnboard] = useState(true);
  const [step, setStep] = useState(0);
  const [auth, setAuth] = useState('welcome');
  const [modals, setModals] = useState({add:false,goal:false,editGoal:false,addAct:false,profile:false,userProf:null});
  const [newEntry, setNewEntry] = useState({act:'running',val:'',notes:'',date:getToday()});
  const [newAct, setNewAct] = useState({name:'',icon:'ğŸ¯',color:'#6366f1',unit:'',daily:'',weekly:'',monthly:''});
  const [newGoal, setNewGoal] = useState({title:'',target:'',unit:'',deadline:''});
  const [editGoals, setEditGoals] = useState({});
  const [regForm, setRegForm] = useState({name:'',avatar:'ğŸ˜€',bio:''});

  const th = dark ? themes.dark : themes.light;
  const me = users.find(u => u.id === uid);
  const others = users.filter(u => u.id !== uid);
  const allActs = me ? {...defActs,...(me.customActs||{})} : defActs;

  useEffect(() => { try { const s=localStorage.getItem('lt-v4'); if(s){const d=JSON.parse(s); setUsers(d.users||[]); setUid(d.uid); setDark(d.dark??true); setOnboard(!d.uid);} } catch(e){} }, []);
  useEffect(() => { if(users.length||uid) localStorage.setItem('lt-v4',JSON.stringify({users,uid,dark})); }, [users,uid,dark]);
  useEffect(() => { const c=()=>setMobile(window.innerWidth<768); c(); window.addEventListener('resize',c); return ()=>window.removeEventListener('resize',c); }, []);

  const streak = entries => { if(!entries?.length)return 0; const ds=[...new Set(entries.map(e=>e.date))].sort().reverse(),td=getToday(),yd=new Date(Date.now()-864e5).toISOString().split('T')[0]; if(ds[0]!==td&&ds[0]!==yd)return 0; let s=0,cd=ds[0]===td?new Date():new Date(Date.now()-864e5); for(const d of ds){if(d===cd.toISOString().split('T')[0]){s++;cd.setDate(cd.getDate()-1);}else break;} return s; };
  const getData = (u,k) => u?.acts?.[k] || u?.customActs?.[k] || null;
  const todayVal = (u,k) => { const d=getData(u,k); return d?(d.entries||[]).filter(e=>e.date===getToday()).reduce((s,e)=>s+parseFloat(e.val||0),0):0; };
  const weekVal = (u,k) => { const d=getData(u,k),w=getWeekDates(); return d?(d.entries||[]).filter(e=>w.includes(e.date)).reduce((s,e)=>s+parseFloat(e.val||0),0):0; };
  const monthVal = (u,k) => { const d=getData(u,k); if(!d)return 0; const ms=new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString().split('T')[0]; return (d.entries||[]).filter(e=>e.date>=ms).reduce((s,e)=>s+parseFloat(e.val||0),0); };
  const totalVal = (u,k) => { const d=getData(u,k); return d?(d.entries||[]).reduce((s,e)=>s+parseFloat(e.val||0),0):0; };
  const weekData = (u,k) => { const d=getData(u,k),w=getWeekDates(),days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim']; return w.map((dt,i)=>({day:days[i],val:(d?.entries||[]).filter(e=>e.date===dt).reduce((s,e)=>s+parseFloat(e.val||0),0)})); };
  const stats = u => { if(!u)return{entries:0,streak:0}; const a={...(u.acts||{}),...(u.customActs||{})}; let e=0,ms=0; Object.values(a).forEach(x=>{e+=(x.entries||[]).length;const s=streak(x.entries);if(s>ms)ms=s;}); return{entries:e,streak:ms}; };

  const register = () => { if(!regForm.name.trim())return; const u={id:'u_'+Date.now(),name:regForm.name.trim(),avatar:regForm.avatar,bio:regForm.bio,followers:[],following:[],acts:{},customActs:{},goals:[]}; setUsers(p=>[...p,u]); setUid(u.id); setOnboard(false); setRegForm({name:'',avatar:'ğŸ˜€',bio:''}); };
  const logout = () => { setUid(null); setOnboard(true); setAuth('welcome'); setStep(0); setModals({add:false,goal:false,editGoal:false,addAct:false,profile:false,userProf:null}); };
  const switchUser = id => { setUid(id); setModals(m=>({...m,profile:false})); setTab('dashboard'); };
  const delAccount = () => { if(!me||!window.confirm('Supprimer ce compte ?'))return; setUsers(p=>p.filter(u=>u.id!==uid).map(u=>({...u,followers:(u.followers||[]).filter(x=>x!==uid),following:(u.following||[]).filter(x=>x!==uid)}))); logout(); };

  const addEntry = () => { if(!newEntry.val||!newEntry.act||!me)return; const e={id:Date.now(),date:newEntry.date,val:parseFloat(newEntry.val),notes:newEntry.notes,at:Date.now()}; setUsers(p=>p.map(u=>{if(u.id!==uid)return u; const isD=defActs[newEntry.act],k=isD?'acts':'customActs',cd=u[k]?.[newEntry.act]||{entries:[],goal:{daily:0,weekly:0,monthly:0}}; return {...u,[k]:{...u[k],[newEntry.act]:{...cd,entries:[...(cd.entries||[]),e]}}};})); setModals(m=>({...m,add:false})); setNewEntry({act:'running',val:'',notes:'',date:getToday()}); };
  const delEntry = (ak,eid) => { setUsers(p=>p.map(u=>{if(u.id!==uid)return u; const isD=defActs[ak],k=isD?'acts':'customActs',cd=u[k]?.[ak]; if(!cd)return u; return {...u,[k]:{...u[k],[ak]:{...cd,entries:cd.entries.filter(e=>e.id!==eid)}}};})); };
  const addAct = () => { if(!newAct.name||!newAct.unit||!me)return; const k=newAct.name.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,''); const a={name:newAct.name,icon:newAct.icon,color:newAct.color,unit:newAct.unit,grad:[newAct.color,newAct.color],entries:[],goal:{daily:+newAct.daily||0,weekly:+newAct.weekly||0,monthly:+newAct.monthly||0}}; setUsers(p=>p.map(u=>u.id===uid?{...u,customActs:{...u.customActs,[k]:a}}:u)); setModals(m=>({...m,addAct:false})); setNewAct({name:'',icon:'ğŸ¯',color:'#6366f1',unit:'',daily:'',weekly:'',monthly:''}); };
  const delAct = k => { if(defActs[k])return; setUsers(p=>p.map(u=>{if(u.id!==uid)return u;const{[k]:_,...r}=u.customActs||{};return{...u,customActs:r};})); if(selAct===k)setSelAct('running'); };
  const saveGoals = () => { if(!selAct||!me)return; const isD=defActs[selAct],k=isD?'acts':'customActs'; setUsers(p=>p.map(u=>{if(u.id!==uid)return u;const cd=u[k]?.[selAct]||{entries:[]};return{...u,[k]:{...u[k],[selAct]:{...cd,goal:editGoals[selAct]}}};})); setModals(m=>({...m,editGoal:false})); };
  const addGoalItem = () => { if(!newGoal.title||!newGoal.target||!me)return; setUsers(p=>p.map(u=>u.id===uid?{...u,goals:[...(u.goals||[]),{id:Date.now(),...newGoal,target:+newGoal.target,current:0}]}:u)); setModals(m=>({...m,goal:false})); setNewGoal({title:'',target:'',unit:'',deadline:''}); };
  const delGoalItem = id => { setUsers(p=>p.map(u=>u.id===uid?{...u,goals:(u.goals||[]).filter(g=>g.id!==id)}:u)); };
  const toggleFollow = tid => { if(!me||tid===uid)return; const isF=(me.following||[]).includes(tid); setUsers(p=>p.map(u=>{if(u.id===uid)return{...u,following:isF?(u.following||[]).filter(x=>x!==tid):[...(u.following||[]),tid]};if(u.id===tid)return{...u,followers:isF?(u.followers||[]).filter(x=>x!==uid):[...(u.followers||[]),uid]};return u;})); };

  const combWeek = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].map((day,i)=>{const w=getWeekDates(),r={day};if(me)Object.keys(allActs).forEach(k=>{const d=getData(me,k);r[k]=(d?.entries||[]).filter(e=>e.date===w[i]).reduce((s,e)=>s+parseFloat(e.val||0),0);});return r;});
  const hasData = me && Object.values({...(me.acts||{}),...(me.customActs||{})}).some(a=>(a.entries||[]).length>0);
  const board = users.map(u=>({...u,st:stats(u)})).sort((a,b)=>b.st.streak-a.st.streak);
  const feed = users.flatMap(u=>{const ua={...defActs,...(u.customActs||{})};return Object.entries({...(u.acts||{}),...(u.customActs||{})}).flatMap(([k,d])=>(d.entries||[]).map(e=>({...e,user:u,actKey:k,cfg:ua[k]||defActs[k]})));}).sort((a,b)=>(b.at||new Date(b.date))-(a.at||new Date(a.date))).slice(0,25);

  const card = {background:th.bgCard,borderRadius:mobile?'12px':'16px',border:'1px solid '+th.border,padding:mobile?'16px':'24px'};
  const btn = {padding:mobile?'10px 16px':'12px 24px',background:th.grad,border:'none',borderRadius:'10px',color:'#fff',fontSize:'14px',fontWeight:'600',cursor:'pointer'};
  const inp = {width:'100%',padding:'12px 14px',background:th.bgCard,border:'1px solid '+th.border,borderRadius:'10px',color:th.text,fontSize:'14px',outline:'none'};
  const btnS = {padding:'8px 16px',background:'transparent',border:'1px solid '+th.border,borderRadius:'8px',color:th.textSec,fontSize:'13px',cursor:'pointer'};

  const Empty = ({icon,title,desc,action,label}) => <div style={{padding:'60px 20px',textAlign:'center',color:th.textMut}}><div style={{fontSize:'48px',marginBottom:'16px'}}>{icon}</div><h3 style={{fontSize:'18px',fontWeight:'600',color:th.text,marginBottom:'8px'}}>{title}</h3><p style={{fontSize:'14px',marginBottom:'20px',maxWidth:'300px',margin:'0 auto 20px'}}>{desc}</p>{action&&<button onClick={action} style={btn}>{label}</button>}</div>;
  const MNav = () => <nav style={{position:'fixed',bottom:0,left:0,right:0,background:th.bgSec,borderTop:'1px solid '+th.border,padding:'8px 0',display:'flex',justifyContent:'space-around',zIndex:1000}}>{[{id:'dashboard',i:'ğŸ“Š',l:'Home'},{id:'activities',i:'ğŸ¯',l:'ActivitÃ©s'},{id:'social',i:'ğŸ‘¥',l:'Social'},{id:'goals',i:'ğŸ†',l:'Goals'}].map(x=><button key={x.id} onClick={()=>setTab(x.id)} style={{flex:1,padding:'8px 4px',background:'transparent',border:'none',color:tab===x.id?th.accent:th.textMut,fontSize:'10px',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',gap:'4px'}}><span style={{fontSize:'20px'}}>{x.i}</span><span>{x.l}</span></button>)}</nav>;

  // ONBOARDING
  if(onboard) return (
    <div style={{minHeight:'100vh',background:th.bg,color:th.text,fontFamily:"'Inter',sans-serif",display:'flex',alignItems:'center',justifyContent:'center',padding:'20px'}}>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');*{box-sizing:border-box;margin:0;padding:0}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}`}</style>
      <div style={{maxWidth:'480px',width:'100%',animation:'fadeIn 0.6s ease-out'}}>
        {auth==='welcome'&&<div style={{textAlign:'center'}}><div style={{fontSize:'80px',marginBottom:'24px',animation:'float 3s ease-in-out infinite'}}>ğŸš€</div><h1 style={{fontSize:'32px',fontWeight:'800',marginBottom:'12px',background:th.grad,WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>LifeTracker</h1><p style={{fontSize:'16px',color:th.textSec,marginBottom:'40px'}}>Track tes activitÃ©s, compare-toi Ã  tes amis.</p><div style={{display:'flex',flexDirection:'column',gap:'12px'}}><button onClick={()=>setAuth('register')} style={{...btn,padding:'16px',fontSize:'16px',width:'100%'}}>CrÃ©er un profil</button>{users.length>0&&<button onClick={()=>setAuth('login')} style={{...btnS,padding:'16px',width:'100%'}}>Changer de profil ({users.length})</button>}</div>{users.length===0&&<p style={{fontSize:'12px',color:th.textMut,marginTop:'24px'}}>ğŸ’¡ CrÃ©e plusieurs profils pour tester le rÃ©seau social !</p>}</div>}
        {auth==='register'&&step===0&&<div style={{textAlign:'center'}}><button onClick={()=>setAuth('welcome')} style={{...btnS,marginBottom:'24px'}}>â† Retour</button><div style={{fontSize:'60px',marginBottom:'24px'}}>ğŸ‘¤</div><h2 style={{fontSize:'24px',fontWeight:'700',marginBottom:'24px'}}>CrÃ©e ton profil</h2><div style={{display:'flex',flexDirection:'column',gap:'16px',textAlign:'left'}}><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>PrÃ©nom *</label><input value={regForm.name} onChange={e=>setRegForm({...regForm,name:e.target.value})} placeholder="Ton prÃ©nom" style={inp}/></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Avatar</label><div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>{avatars.map(a=><button key={a} onClick={()=>setRegForm({...regForm,avatar:a})} style={{width:'44px',height:'44px',fontSize:'24px',background:regForm.avatar===a?th.accent+'20':th.bgCard,border:'2px solid '+(regForm.avatar===a?th.accent:th.border),borderRadius:'10px',cursor:'pointer'}}>{a}</button>)}</div></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Bio</label><input value={regForm.bio} onChange={e=>setRegForm({...regForm,bio:e.target.value})} placeholder="Optionnel" style={inp}/></div><button onClick={()=>regForm.name&&setStep(1)} disabled={!regForm.name} style={{...btn,padding:'16px',opacity:regForm.name?1:0.5}}>Continuer â†’</button></div></div>}
        {auth==='register'&&step===1&&<div style={{textAlign:'center'}}><button onClick={()=>setStep(0)} style={{...btnS,marginBottom:'24px'}}>â† Retour</button><div style={{fontSize:'60px',marginBottom:'24px'}}>ğŸ¯</div><h2 style={{fontSize:'24px',fontWeight:'700',marginBottom:'12px'}}>ActivitÃ©s</h2><p style={{fontSize:'14px',color:th.textSec,marginBottom:'24px'}}>Tu pourras en ajouter d'autres</p><div style={{display:'flex',flexDirection:'column',gap:'10px',marginBottom:'24px'}}>{Object.entries(defActs).map(([k,c])=><div key={k} style={{display:'flex',alignItems:'center',gap:'12px',padding:'12px 16px',background:th.bgCard,borderRadius:'10px',border:'1px solid '+th.border}}><div style={{width:'40px',height:'40px',borderRadius:'10px',background:`linear-gradient(135deg,${c.grad[0]},${c.grad[1]})`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'20px'}}>{c.icon}</div><div style={{textAlign:'left'}}><div style={{fontSize:'14px',fontWeight:'600'}}>{c.name}</div><div style={{fontSize:'11px',color:th.textMut}}>{c.unit}</div></div></div>)}</div><button onClick={register} style={{...btn,padding:'16px',width:'100%',fontSize:'16px'}}>C'est parti ! ğŸš€</button></div>}
        {auth==='login'&&<div style={{textAlign:'center'}}><button onClick={()=>setAuth('welcome')} style={{...btnS,marginBottom:'24px'}}>â† Retour</button><div style={{fontSize:'60px',marginBottom:'24px'}}>ğŸ‘‹</div><h2 style={{fontSize:'24px',fontWeight:'700',marginBottom:'24px'}}>Choisis un profil</h2><div style={{display:'flex',flexDirection:'column',gap:'10px'}}>{users.map(u=><button key={u.id} onClick={()=>{setUid(u.id);setOnboard(false);}} style={{padding:'16px',background:th.bgCard,border:'1px solid '+th.border,borderRadius:'12px',color:th.text,cursor:'pointer',display:'flex',alignItems:'center',gap:'12px',textAlign:'left'}}><div style={{width:'48px',height:'48px',borderRadius:'12px',background:th.grad,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'24px'}}>{u.avatar}</div><div style={{flex:1}}><div style={{fontWeight:'600'}}>{u.name}</div><div style={{fontSize:'12px',color:th.textMut}}>{u.bio||stats(u).entries+' entrÃ©es'}</div></div><div style={{fontSize:'14px',color:th.success,fontWeight:'600'}}>{stats(u).streak}ğŸ”¥</div></button>)}</div></div>}
      </div>
    </div>
  );

  if(!me) return null;

  // MAIN
  return (
    <div style={{minHeight:'100vh',background:th.bg,color:th.text,fontFamily:"'Inter',sans-serif",paddingBottom:mobile?'80px':0}}>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');*{box-sizing:border-box;margin:0;padding:0}@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:${th.border};border-radius:3px}input,textarea{font-family:inherit}`}</style>

      {/* SIDEBAR */}
      {!mobile&&<aside style={{position:'fixed',left:0,top:0,bottom:0,width:'240px',background:th.bgSec,borderRight:'1px solid '+th.border,padding:'20px',display:'flex',flexDirection:'column',zIndex:100}}>
        <h1 style={{fontSize:'20px',fontWeight:'800',marginBottom:'24px',background:th.grad,WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>LifeTracker</h1>
        <div onClick={()=>setModals(m=>({...m,profile:true}))} style={{padding:'12px',background:th.bgCard,borderRadius:'12px',border:'1px solid '+th.border,marginBottom:'20px',cursor:'pointer',display:'flex',alignItems:'center',gap:'10px'}}><div style={{width:'40px',height:'40px',borderRadius:'10px',background:th.grad,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'20px'}}>{me.avatar}</div><div><div style={{fontSize:'14px',fontWeight:'600'}}>{me.name}</div><div style={{fontSize:'11px',color:th.textMut}}>{stats(me).streak}ğŸ”¥</div></div></div>
        <nav style={{flex:1}}><div style={{marginBottom:'6px',fontSize:'10px',color:th.textMut,textTransform:'uppercase',letterSpacing:'1px',padding:'0 12px'}}>Menu</div>{[{id:'dashboard',l:'Dashboard',i:'ğŸ“Š'},{id:'activities',l:'ActivitÃ©s',i:'ğŸ¯'},{id:'social',l:'Social',i:'ğŸ‘¥'},{id:'goals',l:'Objectifs',i:'ğŸ†'}].map(x=><button key={x.id} onClick={()=>setTab(x.id)} style={{width:'100%',padding:'12px 14px',background:tab===x.id?th.accent+'15':'transparent',border:'none',borderRadius:'8px',color:tab===x.id?th.accent:th.textSec,fontSize:'13px',fontWeight:tab===x.id?'600':'500',cursor:'pointer',display:'flex',alignItems:'center',gap:'10px',marginBottom:'2px',textAlign:'left'}}><span style={{fontSize:'16px'}}>{x.i}</span>{x.l}</button>)}<div style={{margin:'20px 0 6px',fontSize:'10px',color:th.textMut,textTransform:'uppercase',letterSpacing:'1px',padding:'0 12px',display:'flex',justifyContent:'space-between'}}><span>ActivitÃ©s</span><button onClick={()=>setModals(m=>({...m,addAct:true}))} style={{background:'transparent',border:'none',color:th.accent,fontSize:'16px',cursor:'pointer'}}>+</button></div>{Object.entries(allActs).map(([k,c])=>{const d=getData(me,k),s=streak(d?.entries);return <button key={k} onClick={()=>{setSelAct(k);setTab('activities');}} style={{width:'100%',padding:'10px 14px',background:selAct===k&&tab==='activities'?c.color+'15':'transparent',border:'none',borderRadius:'8px',color:selAct===k&&tab==='activities'?c.color:th.textSec,fontSize:'13px',cursor:'pointer',display:'flex',alignItems:'center',gap:'10px',marginBottom:'2px',textAlign:'left'}}><span style={{fontSize:'14px'}}>{c.icon}</span>{c.name}{s>0&&<span style={{marginLeft:'auto',fontSize:'11px',padding:'2px 6px',background:c.color+'20',color:c.color,borderRadius:'12px'}}>{s}ğŸ”¥</span>}</button>;})}</nav>
        <div style={{display:'flex',flexDirection:'column',gap:'8px'}}><div style={{padding:'12px',background:th.bgCard,borderRadius:'10px',border:'1px solid '+th.border,display:'flex',alignItems:'center',justifyContent:'space-between'}}><span style={{fontSize:'13px',color:th.textSec}}>{dark?'ğŸŒ™':'â˜€ï¸'}</span><button onClick={()=>setDark(!dark)} style={{width:'44px',height:'24px',background:dark?th.accent:th.border,border:'none',borderRadius:'12px',cursor:'pointer',position:'relative'}}><div style={{width:'18px',height:'18px',background:'#fff',borderRadius:'50%',position:'absolute',top:'3px',left:dark?'23px':'3px',transition:'all 0.3s'}}/></button></div><button onClick={logout} style={{...btnS,width:'100%',fontSize:'12px'}}>Changer de profil</button></div>
      </aside>}

      {/* MOBILE HEADER */}
      {mobile&&<header style={{position:'sticky',top:0,background:th.bgSec,borderBottom:'1px solid '+th.border,padding:'12px 16px',display:'flex',justifyContent:'space-between',alignItems:'center',zIndex:100}}><div style={{display:'flex',alignItems:'center',gap:'10px'}} onClick={()=>setModals(m=>({...m,profile:true}))}><div style={{width:'36px',height:'36px',borderRadius:'10px',background:th.grad,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px'}}>{me.avatar}</div><div><div style={{fontSize:'14px',fontWeight:'700'}}>{me.name}</div><div style={{fontSize:'10px',color:th.textMut}}>{stats(me).streak}ğŸ”¥</div></div></div><div style={{display:'flex',gap:'10px'}}><button onClick={()=>setDark(!dark)} style={{width:'36px',height:'36px',borderRadius:'10px',background:th.bgCard,border:'1px solid '+th.border,fontSize:'16px',cursor:'pointer'}}>{dark?'ğŸŒ™':'â˜€ï¸'}</button><button onClick={()=>setModals(m=>({...m,add:true}))} style={{...btn,padding:'10px 14px',fontSize:'13px'}}>+</button></div></header>}

      {/* MAIN */}
      <main style={{marginLeft:mobile?0:'240px',padding:mobile?'16px':'24px',minHeight:'100vh'}}>
        {!mobile&&<header style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'24px'}}><div><h2 style={{fontSize:'24px',fontWeight:'700',marginBottom:'2px'}}>{tab==='dashboard'?'Dashboard':tab==='activities'?allActs[selAct]?.name:tab==='social'?'Social':'Objectifs'}</h2><p style={{color:th.textSec,fontSize:'13px'}}>{new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'})}</p></div><button onClick={()=>setModals(m=>({...m,add:true}))} style={btn}>+ Ajouter</button></header>}

        {/* DASHBOARD */}
        {tab==='dashboard'&&<div style={{animation:'slideIn 0.4s ease-out'}}>
          <div style={{display:'grid',gridTemplateColumns:mobile?'repeat(2,1fr)':'repeat(5,1fr)',gap:mobile?'12px':'16px',marginBottom:'24px'}}>{Object.entries(allActs).slice(0,5).map(([k,c])=>{const d=getData(me,k),tv=todayVal(me,k),g=d?.goal?.daily||0,pct=g?Math.min(tv/g*100,100):0;return <div key={k} style={{...card,cursor:'pointer',position:'relative',overflow:'hidden'}} onClick={()=>{setSelAct(k);setTab('activities');}}><div style={{position:'absolute',top:-20,right:-20,width:'60px',height:'60px',background:`linear-gradient(135deg,${c.color}30,transparent)`,borderRadius:'50%'}}/><div style={{fontSize:mobile?'24px':'28px',marginBottom:'8px'}}>{c.icon}</div><div style={{fontSize:'11px',color:th.textMut,marginBottom:'2px'}}>{c.name}</div><div style={{fontSize:mobile?'20px':'22px',fontWeight:'700',color:c.color}}>{tv.toFixed(1)}<span style={{fontSize:'12px',fontWeight:'400',color:th.textMut,marginLeft:'3px'}}>{c.unit}</span></div>{g>0&&<div style={{marginTop:'10px',height:'4px',background:th.border,borderRadius:'2px',overflow:'hidden'}}><div style={{width:pct+'%',height:'100%',background:`linear-gradient(90deg,${c.grad[0]},${c.grad[1]})`,borderRadius:'2px'}}/></div>}</div>;})}</div>
          {!hasData?<div style={card}><Empty icon="ğŸ“" title="Commence !" desc="Ajoute ta premiÃ¨re activitÃ©" action={()=>setModals(m=>({...m,add:true}))} label="+ Ajouter"/></div>:<>
            <div style={{display:'grid',gridTemplateColumns:mobile?'1fr':'2fr 1fr',gap:'20px',marginBottom:'24px'}}>
              <div style={card}><h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'20px'}}>ğŸ“ˆ Semaine</h3><ResponsiveContainer width="100%" height={mobile?200:250}><AreaChart data={combWeek}><defs>{Object.entries(allActs).map(([k,c])=><linearGradient key={k} id={'g-'+k} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={c.color} stopOpacity={0.3}/><stop offset="100%" stopColor={c.color} stopOpacity={0}/></linearGradient>)}</defs><XAxis dataKey="day" axisLine={false} tickLine={false} tick={{fill:th.textMut,fontSize:11}}/><YAxis axisLine={false} tickLine={false} tick={{fill:th.textMut,fontSize:11}} width={30}/><Tooltip contentStyle={{background:th.bgSec,border:'1px solid '+th.border,borderRadius:'8px',fontSize:'12px'}}/>{Object.entries(allActs).map(([k,c])=><Area key={k} type="monotone" dataKey={k} stroke={c.color} fill={`url(#g-${k})`} strokeWidth={2}/>)}</AreaChart></ResponsiveContainer></div>
              <div style={card}><h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'16px'}}>ğŸ”¥ Streaks</h3><div style={{display:'flex',flexDirection:'column',gap:'10px'}}>{Object.entries(allActs).map(([k,c])=>{const d=getData(me,k),s=streak(d?.entries);return <div key={k} style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}><div style={{display:'flex',alignItems:'center',gap:'8px'}}><span>{c.icon}</span><span style={{fontSize:'13px'}}>{c.name}</span></div><span style={{padding:'4px 10px',background:s>=7?th.success+'20':th.bgCard,borderRadius:'12px',fontSize:'12px',fontWeight:'600',color:s>=7?th.success:th.text}}>{s}j</span></div>;})}</div></div>
            </div>
            {others.length>0&&<div style={card}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}><h3 style={{fontSize:'15px',fontWeight:'600'}}>ğŸ‘¥ CommunautÃ© ({users.length})</h3><button onClick={()=>setTab('social')} style={{...btnS,padding:'6px 12px',fontSize:'11px'}}>Voir â†’</button></div><div style={{display:'flex',gap:'12px',overflowX:'auto',paddingBottom:'8px'}}>{board.slice(0,5).map((u,i)=><div key={u.id} onClick={()=>u.id!==uid&&setModals(m=>({...m,userProf:u}))} style={{minWidth:'110px',padding:'14px',background:u.id===uid?th.accent+'10':th.bgCard,borderRadius:'12px',textAlign:'center',cursor:u.id===uid?'default':'pointer',border:'1px solid '+(u.id===uid?th.accent:th.border)}}><div style={{fontSize:'12px',color:i===0?'#fbbf24':i===1?'#94a3b8':i===2?'#cd7c32':th.textMut,marginBottom:'6px'}}>#{i+1}</div><div style={{fontSize:'28px',marginBottom:'6px'}}>{u.avatar}</div><div style={{fontSize:'12px',fontWeight:'600',marginBottom:'2px'}}>{u.name}{u.id===uid&&' (toi)'}</div><div style={{fontSize:'11px',color:th.success}}>{u.st.streak}ğŸ”¥</div></div>)}</div></div>}
          </>}
        </div>}

        {/* ACTIVITIES */}
        {tab==='activities'&&selAct&&allActs[selAct]&&(()=>{const c=allActs[selAct],d=getData(me,selAct),isC=!defActs[selAct],s=streak(d?.entries);return <div style={{animation:'slideIn 0.4s ease-out'}}>
          {mobile&&<div style={{display:'flex',gap:'8px',overflowX:'auto',paddingBottom:'12px',marginBottom:'16px'}}>{Object.entries(allActs).map(([k,x])=><button key={k} onClick={()=>setSelAct(k)} style={{padding:'10px 16px',background:selAct===k?x.color+'20':th.bgCard,border:'1px solid '+(selAct===k?x.color:th.border),borderRadius:'10px',color:selAct===k?x.color:th.textSec,fontSize:'13px',cursor:'pointer',whiteSpace:'nowrap'}}>{x.icon} {x.name}</button>)}<button onClick={()=>setModals(m=>({...m,addAct:true}))} style={{padding:'10px 16px',background:th.bgCard,border:'1px dashed '+th.border,borderRadius:'10px',color:th.accent,fontSize:'13px',cursor:'pointer',whiteSpace:'nowrap'}}>+ Nouvelle</button></div>}
          <div style={{...card,background:`linear-gradient(135deg,${c.color}10,${c.color}05)`,borderColor:c.color+'30',marginBottom:'20px'}}><div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'20px',flexWrap:'wrap',gap:'12px'}}><div style={{display:'flex',alignItems:'center',gap:'16px'}}><div style={{width:'56px',height:'56px',borderRadius:'14px',background:`linear-gradient(135deg,${c.grad[0]},${c.grad[1]})`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'28px'}}>{c.icon}</div><div><h3 style={{fontSize:'18px',fontWeight:'700',marginBottom:'2px'}}>{c.name}</h3><p style={{fontSize:'12px',color:th.textSec}}>Streak: {s}j</p></div></div>{isC&&<button onClick={()=>delAct(selAct)} style={{...btnS,color:th.danger,borderColor:th.danger}}>ğŸ—‘ï¸</button>}</div><div style={{display:'grid',gridTemplateColumns:mobile?'repeat(2,1fr)':'repeat(4,1fr)',gap:'12px'}}>{[{l:"Aujourd'hui",v:todayVal(me,selAct)},{l:'Semaine',v:weekVal(me,selAct)},{l:'Mois',v:monthVal(me,selAct)},{l:'Total',v:totalVal(me,selAct)}].map((x,i)=><div key={i} style={{padding:'14px',background:th.bgCard,borderRadius:'10px',textAlign:'center'}}><div style={{fontSize:'11px',color:th.textMut,marginBottom:'4px'}}>{x.l}</div><div style={{fontSize:'20px',fontWeight:'700',color:c.color}}>{x.v.toFixed(1)}<span style={{fontSize:'11px',color:th.textMut}}> {c.unit}</span></div></div>)}</div></div>
          <div style={{...card,marginBottom:'20px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}><h3 style={{fontSize:'15px',fontWeight:'600'}}>ğŸ¯ Objectifs</h3><button onClick={()=>{setEditGoals({[selAct]:d?.goal||{daily:0,weekly:0,monthly:0}});setModals(m=>({...m,editGoal:true}));}} style={{...btnS,padding:'6px 12px',fontSize:'11px'}}>âœï¸</button></div><div style={{display:'grid',gridTemplateColumns:mobile?'1fr':'repeat(3,1fr)',gap:'12px'}}>{[{l:'Quotidien',cur:todayVal(me,selAct),tar:d?.goal?.daily||0},{l:'Hebdo',cur:weekVal(me,selAct),tar:d?.goal?.weekly||0},{l:'Mensuel',cur:monthVal(me,selAct),tar:d?.goal?.monthly||0}].map((g,i)=>{const pct=g.tar?Math.round(g.cur/g.tar*100):0;return <div key={i} style={{padding:'14px',background:th.bgCard,borderRadius:'10px',border:'1px solid '+th.border}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'8px'}}><span style={{fontSize:'12px'}}>{g.l}</span><span style={{fontSize:'11px',color:pct>=100?th.success:th.textMut}}>{g.tar>0?pct+'%':'-'}</span></div><div style={{height:'6px',background:th.border,borderRadius:'3px',overflow:'hidden',marginBottom:'6px'}}><div style={{width:Math.min(pct,100)+'%',height:'100%',background:c.color,borderRadius:'3px'}}/></div><div style={{fontSize:'11px',color:th.textMut,textAlign:'center'}}>{g.cur.toFixed(1)} / {g.tar||'â€”'}</div></div>;})}</div></div>
          {(d?.entries||[]).length===0?<div style={card}><Empty icon={c.icon} title="Aucune entrÃ©e" desc="Ajoute ta premiÃ¨re session !" action={()=>{setNewEntry({...newEntry,act:selAct});setModals(m=>({...m,add:true}));}} label="+ Ajouter"/></div>:<><div style={{...card,marginBottom:'20px'}}><h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'16px'}}>ğŸ“Š Semaine</h3><ResponsiveContainer width="100%" height={200}><BarChart data={weekData(me,selAct)}><XAxis dataKey="day" axisLine={false} tickLine={false} tick={{fill:th.textMut,fontSize:11}}/><YAxis axisLine={false} tickLine={false} tick={{fill:th.textMut,fontSize:11}} width={30}/><Tooltip contentStyle={{background:th.bgSec,border:'1px solid '+th.border,borderRadius:'8px',fontSize:'12px'}}/><Bar dataKey="val" fill={c.color} radius={[4,4,0,0]}/></BarChart></ResponsiveContainer></div><div style={card}><h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'16px'}}>ğŸ“‹ Historique</h3><div style={{display:'flex',flexDirection:'column',gap:'8px'}}>{(d?.entries||[]).slice().reverse().slice(0,15).map(e=><div key={e.id} style={{display:'flex',alignItems:'center',padding:'12px',background:th.bgCard,borderRadius:'10px',border:'1px solid '+th.border,gap:'12px'}}><div style={{width:'36px',height:'36px',borderRadius:'8px',background:c.color+'20',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'16px'}}>{c.icon}</div><div style={{flex:1}}><div style={{fontSize:'14px',fontWeight:'600',color:c.color}}>{e.val} {c.unit}</div>{e.notes&&<div style={{fontSize:'11px',color:th.textMut}}>{e.notes}</div>}</div><div style={{fontSize:'11px',color:th.textMut}}>{fmtDate(e.date)}</div><button onClick={()=>delEntry(selAct,e.id)} style={{width:'28px',height:'28px',background:'transparent',border:'1px solid '+th.border,borderRadius:'6px',color:th.textMut,fontSize:'14px',cursor:'pointer'}}>Ã—</button></div>)}</div></div></>}
        </div>;})()}

        {/* SOCIAL */}
        {tab==='social'&&<div style={{animation:'slideIn 0.4s ease-out'}}>
          {users.length<=1?<div style={card}><Empty icon="ğŸ‘¥" title="Tu es seul !" desc="CrÃ©e d'autres profils pour tester le social" action={()=>{logout();setAuth('register');}} label="+ CrÃ©er"/><p style={{textAlign:'center',fontSize:'12px',color:th.textMut,marginTop:'16px'}}>ğŸ’¡ Switch entre profils pour simuler diffÃ©rents users !</p></div>:
          <div style={{display:'grid',gridTemplateColumns:mobile?'1fr':'1fr 1fr',gap:'20px'}}>
            <div style={card}><h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'16px'}}>ğŸ† Classement ({users.length})</h3><div style={{display:'flex',flexDirection:'column',gap:'10px'}}>{board.map((u,i)=>{const isMe=u.id===uid,isF=(me?.following||[]).includes(u.id);return <div key={u.id} onClick={()=>!isMe&&setModals(m=>({...m,userProf:u}))} style={{display:'flex',alignItems:'center',padding:'12px',background:isMe?th.accent+'10':th.bgCard,borderRadius:'10px',cursor:isMe?'default':'pointer',gap:'12px',border:'1px solid '+(isMe?th.accent:th.border)}}><div style={{fontSize:'14px',fontWeight:'700',color:i===0?'#fbbf24':i===1?'#94a3b8':i===2?'#cd7c32':th.textMut,width:'24px'}}>#{i+1}</div><div style={{width:'40px',height:'40px',borderRadius:'10px',background:th.grad,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'20px'}}>{u.avatar}</div><div style={{flex:1}}><div style={{fontSize:'14px',fontWeight:'600',display:'flex',alignItems:'center',gap:'6px'}}>{u.name}{isMe&&<span style={{fontSize:'10px',padding:'2px 6px',background:th.accent,color:'#fff',borderRadius:'4px'}}>Toi</span>}{isF&&!isMe&&<span style={{fontSize:'10px',color:th.accent}}>âœ“</span>}</div><div style={{fontSize:'11px',color:th.textMut}}>{u.bio||u.st.entries+' entrÃ©es'}</div></div><div style={{textAlign:'right'}}><div style={{fontSize:'14px',fontWeight:'700',color:th.success}}>{u.st.streak}ğŸ”¥</div><div style={{fontSize:'10px',color:th.textMut}}>{(u.followers||[]).length} followers</div></div></div>;})}</div></div>
            <div style={card}><h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'16px'}}>ğŸ“° ActivitÃ©</h3>{feed.length===0?<div style={{textAlign:'center',padding:'40px',color:th.textMut}}><div style={{fontSize:'32px',marginBottom:'8px'}}>ğŸƒ</div><p>Aucune activitÃ©</p></div>:<div style={{display:'flex',flexDirection:'column',gap:'10px',maxHeight:'500px',overflowY:'auto'}}>{feed.map((e,i)=>{const isOwn=e.user.id===uid;return <div key={`${e.user.id}-${e.id}-${i}`} style={{display:'flex',alignItems:'flex-start',padding:'12px',background:isOwn?th.accent+'08':th.bgCard,borderRadius:'10px',gap:'10px',border:'1px solid '+th.border}}><div onClick={()=>!isOwn&&setModals(m=>({...m,userProf:e.user}))} style={{width:'36px',height:'36px',borderRadius:'8px',background:th.grad,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'16px',cursor:isOwn?'default':'pointer',flexShrink:0}}>{e.user.avatar}</div><div style={{flex:1,minWidth:0}}><div style={{fontSize:'13px'}}><span style={{fontWeight:'600'}}>{e.user.name}{isOwn&&' (toi)'}</span> a fait <span style={{color:e.cfg?.color,fontWeight:'600'}}>{e.val} {e.cfg?.unit}</span> de {e.cfg?.name}</div>{e.notes&&<div style={{fontSize:'11px',color:th.textMut,marginTop:'4px'}}>"{e.notes}"</div>}<div style={{fontSize:'10px',color:th.textMut,marginTop:'4px'}}>{fmtDate(e.date)}</div></div></div>;})}</div>}</div>
          </div>}
          {users.length>1&&users.length<4&&<div style={{marginTop:'20px',padding:'16px',background:th.bgCard,borderRadius:'12px',border:'1px dashed '+th.border,textAlign:'center'}}><p style={{fontSize:'13px',color:th.textSec}}>ğŸ’¡ CrÃ©e plus de profils pour un classement plus fun !</p><button onClick={()=>{logout();setAuth('register');}} style={{...btnS,marginTop:'12px'}}>+ Nouveau</button></div>}
        </div>}

        {/* GOALS */}
        {tab==='goals'&&<div style={{animation:'slideIn 0.4s ease-out'}}>
          <div style={{marginBottom:'20px'}}><button onClick={()=>setModals(m=>({...m,goal:true}))} style={{...btn,width:mobile?'100%':'auto'}}>+ CrÃ©er</button></div>
          <div style={{...card,marginBottom:'20px'}}><h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'16px'}}>ğŸ“… Par activitÃ©</h3><div style={{display:'grid',gridTemplateColumns:mobile?'1fr':'repeat(2,1fr)',gap:'12px'}}>{Object.entries(allActs).map(([k,c])=>{const d=getData(me,k),dp=d?.goal?.daily?Math.round(todayVal(me,k)/d.goal.daily*100):0,wp=d?.goal?.weekly?Math.round(weekVal(me,k)/d.goal.weekly*100):0;return <div key={k} style={{padding:'14px',background:th.bgCard,borderRadius:'10px',border:'1px solid '+th.border}}><div style={{display:'flex',alignItems:'center',gap:'10px',marginBottom:'12px'}}><span style={{fontSize:'20px'}}>{c.icon}</span><span style={{fontSize:'14px',fontWeight:'600'}}>{c.name}</span></div><div style={{display:'flex',gap:'8px'}}>{[{l:'Jour',p:dp},{l:'Sem',p:wp}].map(g=><div key={g.l} style={{flex:1,textAlign:'center'}}><div style={{fontSize:'10px',color:th.textMut,marginBottom:'4px'}}>{g.l}</div><div style={{height:'6px',background:th.border,borderRadius:'3px',marginBottom:'4px'}}><div style={{width:Math.min(g.p,100)+'%',height:'100%',background:g.p>=100?th.success:c.color,borderRadius:'3px'}}/></div><div style={{fontSize:'11px',fontWeight:'600',color:g.p>=100?th.success:th.text}}>{g.p}%</div></div>)}</div></div>;})}</div></div>
          <div style={card}><h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'16px'}}>ğŸ¯ Perso</h3>{(me.goals||[]).length===0?<Empty icon="ğŸ¯" title="Aucun objectif" desc="CrÃ©e-toi des objectifs !" action={()=>setModals(m=>({...m,goal:true}))} label="+ CrÃ©er"/>:<div style={{display:'flex',flexDirection:'column',gap:'10px'}}>{(me.goals||[]).map(g=>{const pct=Math.round(g.current/g.target*100);return <div key={g.id} style={{padding:'14px',background:th.bgCard,borderRadius:'10px',border:'1px solid '+th.border}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'10px'}}><span style={{fontSize:'14px',fontWeight:'600'}}>{g.title}</span><div style={{display:'flex',alignItems:'center',gap:'8px'}}><span style={{fontSize:'12px',color:th.accent,fontWeight:'600'}}>{pct}%</span><button onClick={()=>delGoalItem(g.id)} style={{width:'24px',height:'24px',background:'transparent',border:'1px solid '+th.border,borderRadius:'6px',color:th.textMut,fontSize:'12px',cursor:'pointer'}}>Ã—</button></div></div><div style={{height:'6px',background:th.border,borderRadius:'3px',overflow:'hidden'}}><div style={{width:Math.min(pct,100)+'%',height:'100%',background:th.accent,borderRadius:'3px'}}/></div><div style={{fontSize:'11px',color:th.textMut,marginTop:'6px'}}>{g.current}/{g.target} {g.unit}{g.deadline&&` â€¢ ${fmtDate(g.deadline)}`}</div></div>;})}</div>}</div>
        </div>}
      </main>
      {mobile&&<MNav/>}

      {/* MODALS */}
      {modals.add&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:mobile?'flex-end':'center',justifyContent:'center',zIndex:1001}}><div style={{background:th.bgSec,borderRadius:mobile?'20px 20px 0 0':'16px',padding:'24px',width:mobile?'100%':'420px',maxHeight:'90vh',overflowY:'auto',border:'1px solid '+th.border}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}><h3 style={{fontSize:'18px',fontWeight:'700'}}>Nouvelle entrÃ©e</h3><button onClick={()=>setModals(m=>({...m,add:false}))} style={{width:'32px',height:'32px',borderRadius:'8px',background:th.bgCard,border:'1px solid '+th.border,color:th.textSec,fontSize:'18px',cursor:'pointer'}}>Ã—</button></div><div style={{display:'flex',flexDirection:'column',gap:'16px'}}><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>ActivitÃ© *</label><div style={{display:'flex',gap:'6px',flexWrap:'wrap'}}>{Object.entries(allActs).map(([k,c])=><button key={k} onClick={()=>setNewEntry({...newEntry,act:k})} style={{padding:'10px 14px',background:newEntry.act===k?c.color+'20':th.bgCard,border:'1px solid '+(newEntry.act===k?c.color:th.border),borderRadius:'8px',color:newEntry.act===k?c.color:th.textSec,fontSize:'12px',cursor:'pointer'}}>{c.icon} {c.name}</button>)}</div></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Valeur ({allActs[newEntry.act]?.unit}) *</label><input type="number" step="0.1" value={newEntry.val} onChange={e=>setNewEntry({...newEntry,val:e.target.value})} placeholder="Ex: 5" style={inp}/></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Date</label><input type="date" value={newEntry.date} onChange={e=>setNewEntry({...newEntry,date:e.target.value})} style={inp}/></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Notes</label><textarea value={newEntry.notes} onChange={e=>setNewEntry({...newEntry,notes:e.target.value})} placeholder="Optionnel" rows={2} style={{...inp,resize:'none'}}/></div><button onClick={addEntry} disabled={!newEntry.act||!newEntry.val} style={{...btn,width:'100%',padding:'14px',opacity:newEntry.act&&newEntry.val?1:0.5}}>âœ“ Enregistrer</button></div></div></div>}

      {modals.addAct&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:mobile?'flex-end':'center',justifyContent:'center',zIndex:1001}}><div style={{background:th.bgSec,borderRadius:mobile?'20px 20px 0 0':'16px',padding:'24px',width:mobile?'100%':'420px',maxHeight:'90vh',overflowY:'auto',border:'1px solid '+th.border}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}><h3 style={{fontSize:'18px',fontWeight:'700'}}>Nouvelle activitÃ©</h3><button onClick={()=>setModals(m=>({...m,addAct:false}))} style={{width:'32px',height:'32px',borderRadius:'8px',background:th.bgCard,border:'1px solid '+th.border,color:th.textSec,fontSize:'18px',cursor:'pointer'}}>Ã—</button></div><div style={{display:'flex',flexDirection:'column',gap:'16px'}}><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Nom *</label><input value={newAct.name} onChange={e=>setNewAct({...newAct,name:e.target.value})} placeholder="Ex: MÃ©ditation" style={inp}/></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>IcÃ´ne</label><div style={{display:'flex',gap:'6px',flexWrap:'wrap'}}>{icons.map(ic=><button key={ic} onClick={()=>setNewAct({...newAct,icon:ic})} style={{width:'40px',height:'40px',fontSize:'20px',background:newAct.icon===ic?th.accent+'20':th.bgCard,border:'2px solid '+(newAct.icon===ic?th.accent:th.border),borderRadius:'8px',cursor:'pointer'}}>{ic}</button>)}</div></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Couleur</label><div style={{display:'flex',gap:'6px',flexWrap:'wrap'}}>{colors.map(c=><button key={c} onClick={()=>setNewAct({...newAct,color:c})} style={{width:'32px',height:'32px',background:c,border:'3px solid '+(newAct.color===c?'#fff':'transparent'),borderRadius:'8px',cursor:'pointer',boxShadow:newAct.color===c?'0 0 0 2px '+c:'none'}}/>)}</div></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>UnitÃ© *</label><input value={newAct.unit} onChange={e=>setNewAct({...newAct,unit:e.target.value})} placeholder="Ex: min" style={inp}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'8px'}}><div><label style={{fontSize:'10px',color:th.textMut}}>Obj. jour</label><input type="number" value={newAct.daily} onChange={e=>setNewAct({...newAct,daily:e.target.value})} style={inp}/></div><div><label style={{fontSize:'10px',color:th.textMut}}>Obj. sem</label><input type="number" value={newAct.weekly} onChange={e=>setNewAct({...newAct,weekly:e.target.value})} style={inp}/></div><div><label style={{fontSize:'10px',color:th.textMut}}>Obj. mois</label><input type="number" value={newAct.monthly} onChange={e=>setNewAct({...newAct,monthly:e.target.value})} style={inp}/></div></div><button onClick={addAct} disabled={!newAct.name||!newAct.unit} style={{...btn,width:'100%',padding:'14px',opacity:newAct.name&&newAct.unit?1:0.5}}>âœ“ CrÃ©er</button></div></div></div>}

      {modals.editGoal&&selAct&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:mobile?'flex-end':'center',justifyContent:'center',zIndex:1001}}><div style={{background:th.bgSec,borderRadius:mobile?'20px 20px 0 0':'16px',padding:'24px',width:mobile?'100%':'380px',border:'1px solid '+th.border}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}><h3 style={{fontSize:'18px',fontWeight:'700'}}>Objectifs {allActs[selAct]?.name}</h3><button onClick={()=>setModals(m=>({...m,editGoal:false}))} style={{width:'32px',height:'32px',borderRadius:'8px',background:th.bgCard,border:'1px solid '+th.border,color:th.textSec,fontSize:'18px',cursor:'pointer'}}>Ã—</button></div><div style={{display:'flex',flexDirection:'column',gap:'16px'}}><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Quotidien ({allActs[selAct]?.unit})</label><input type="number" value={editGoals[selAct]?.daily||''} onChange={e=>setEditGoals({...editGoals,[selAct]:{...editGoals[selAct],daily:+e.target.value||0}})} style={inp}/></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Hebdomadaire</label><input type="number" value={editGoals[selAct]?.weekly||''} onChange={e=>setEditGoals({...editGoals,[selAct]:{...editGoals[selAct],weekly:+e.target.value||0}})} style={inp}/></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Mensuel</label><input type="number" value={editGoals[selAct]?.monthly||''} onChange={e=>setEditGoals({...editGoals,[selAct]:{...editGoals[selAct],monthly:+e.target.value||0}})} style={inp}/></div><button onClick={saveGoals} style={{...btn,width:'100%',padding:'14px'}}>âœ“ Enregistrer</button></div></div></div>}

      {modals.goal&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:mobile?'flex-end':'center',justifyContent:'center',zIndex:1001}}><div style={{background:th.bgSec,borderRadius:mobile?'20px 20px 0 0':'16px',padding:'24px',width:mobile?'100%':'420px',border:'1px solid '+th.border}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}><h3 style={{fontSize:'18px',fontWeight:'700'}}>Nouvel objectif</h3><button onClick={()=>setModals(m=>({...m,goal:false}))} style={{width:'32px',height:'32px',borderRadius:'8px',background:th.bgCard,border:'1px solid '+th.border,color:th.textSec,fontSize:'18px',cursor:'pointer'}}>Ã—</button></div><div style={{display:'flex',flexDirection:'column',gap:'16px'}}><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Titre *</label><input value={newGoal.title} onChange={e=>setNewGoal({...newGoal,title:e.target.value})} placeholder="Ex: Marathon" style={inp}/></div><div style={{display:'grid',gridTemplateColumns:'2fr 1fr',gap:'12px'}}><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Cible *</label><input type="number" value={newGoal.target} onChange={e=>setNewGoal({...newGoal,target:e.target.value})} placeholder="42" style={inp}/></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>UnitÃ©</label><input value={newGoal.unit} onChange={e=>setNewGoal({...newGoal,unit:e.target.value})} placeholder="km" style={inp}/></div></div><div><label style={{fontSize:'12px',color:th.textSec,display:'block',marginBottom:'8px'}}>Deadline</label><input type="date" value={newGoal.deadline} onChange={e=>setNewGoal({...newGoal,deadline:e.target.value})} style={inp}/></div><button onClick={addGoalItem} disabled={!newGoal.title||!newGoal.target} style={{...btn,width:'100%',padding:'14px',opacity:newGoal.title&&newGoal.target?1:0.5}}>âœ“ CrÃ©er</button></div></div></div>}

      {modals.profile&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:mobile?'flex-end':'center',justifyContent:'center',zIndex:1001}}><div style={{background:th.bgSec,borderRadius:mobile?'20px 20px 0 0':'16px',padding:'24px',width:mobile?'100%':'400px',maxHeight:'90vh',overflowY:'auto',border:'1px solid '+th.border}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}><h3 style={{fontSize:'18px',fontWeight:'700'}}>Mon profil</h3><button onClick={()=>setModals(m=>({...m,profile:false}))} style={{width:'32px',height:'32px',borderRadius:'8px',background:th.bgCard,border:'1px solid '+th.border,color:th.textSec,fontSize:'18px',cursor:'pointer'}}>Ã—</button></div><div style={{textAlign:'center',marginBottom:'24px'}}><div style={{width:'80px',height:'80px',borderRadius:'20px',background:th.grad,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'40px',margin:'0 auto 12px'}}>{me.avatar}</div><div style={{fontSize:'20px',fontWeight:'700'}}>{me.name}</div>{me.bio&&<div style={{fontSize:'13px',color:th.textSec,marginTop:'4px'}}>{me.bio}</div>}<div style={{display:'flex',justifyContent:'center',gap:'24px',marginTop:'16px'}}><div><div style={{fontSize:'18px',fontWeight:'700'}}>{stats(me).entries}</div><div style={{fontSize:'11px',color:th.textMut}}>EntrÃ©es</div></div><div><div style={{fontSize:'18px',fontWeight:'700',color:th.success}}>{stats(me).streak}ğŸ”¥</div><div style={{fontSize:'11px',color:th.textMut}}>Streak</div></div><div><div style={{fontSize:'18px',fontWeight:'700'}}>{(me.followers||[]).length}</div><div style={{fontSize:'11px',color:th.textMut}}>Followers</div></div></div></div>{others.length>0&&<div style={{marginBottom:'16px'}}><div style={{fontSize:'12px',color:th.textMut,marginBottom:'8px'}}>Autres profils :</div><div style={{display:'flex',flexDirection:'column',gap:'8px'}}>{others.map(u=><button key={u.id} onClick={()=>switchUser(u.id)} style={{padding:'10px 14px',background:th.bgCard,border:'1px solid '+th.border,borderRadius:'10px',color:th.text,cursor:'pointer',display:'flex',alignItems:'center',gap:'10px',textAlign:'left'}}><span style={{fontSize:'20px'}}>{u.avatar}</span><div style={{flex:1}}><div style={{fontWeight:'600'}}>{u.name}</div><div style={{fontSize:'11px',color:th.textMut}}>{stats(u).entries} entrÃ©es</div></div><span style={{color:th.success,fontSize:'12px'}}>{stats(u).streak}ğŸ”¥</span></button>)}</div></div>}<div style={{display:'flex',flexDirection:'column',gap:'8px'}}><button onClick={()=>{logout();setAuth('register');}} style={{...btnS,width:'100%'}}>+ Nouveau profil</button><button onClick={logout} style={{...btnS,width:'100%'}}>Changer</button><button onClick={delAccount} style={{...btnS,width:'100%',color:th.danger,borderColor:th.danger}}>ğŸ—‘ï¸ Supprimer</button></div></div></div>}

      {modals.userProf&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:mobile?'flex-end':'center',justifyContent:'center',zIndex:1001}}><div style={{background:th.bgSec,borderRadius:mobile?'20px 20px 0 0':'16px',padding:'24px',width:mobile?'100%':'420px',maxHeight:'90vh',overflowY:'auto',border:'1px solid '+th.border}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}><h3 style={{fontSize:'18px',fontWeight:'700'}}>Profil</h3><button onClick={()=>setModals(m=>({...m,userProf:null}))} style={{width:'32px',height:'32px',borderRadius:'8px',background:th.bgCard,border:'1px solid '+th.border,color:th.textSec,fontSize:'18px',cursor:'pointer'}}>Ã—</button></div><div style={{textAlign:'center',marginBottom:'24px'}}><div style={{width:'80px',height:'80px',borderRadius:'20px',background:th.grad,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'40px',margin:'0 auto 12px'}}>{modals.userProf.avatar}</div><div style={{fontSize:'20px',fontWeight:'700'}}>{modals.userProf.name}</div>{modals.userProf.bio&&<div style={{fontSize:'13px',color:th.textSec,marginTop:'4px'}}>{modals.userProf.bio}</div>}<div style={{display:'flex',justifyContent:'center',gap:'20px',marginTop:'16px'}}><div><div style={{fontSize:'16px',fontWeight:'700'}}>{(modals.userProf.followers||[]).length}</div><div style={{fontSize:'10px',color:th.textMut}}>Followers</div></div><div><div style={{fontSize:'16px',fontWeight:'700'}}>{(modals.userProf.following||[]).length}</div><div style={{fontSize:'10px',color:th.textMut}}>Following</div></div><div><div style={{fontSize:'16px',fontWeight:'700',color:th.success}}>{stats(modals.userProf).streak}ğŸ”¥</div><div style={{fontSize:'10px',color:th.textMut}}>Streak</div></div></div>{modals.userProf.id!==uid&&<button onClick={()=>toggleFollow(modals.userProf.id)} style={{...((me?.following||[]).includes(modals.userProf.id)?btnS:btn),marginTop:'16px',padding:'10px 24px'}}>{(me?.following||[]).includes(modals.userProf.id)?'âœ“ Suivi':'+ Suivre'}</button>}</div><div><div style={{fontSize:'14px',fontWeight:'600',marginBottom:'12px'}}>ActivitÃ©s</div><div style={{display:'flex',flexDirection:'column',gap:'8px'}}>{Object.entries({...(modals.userProf.acts||{}),...(modals.userProf.customActs||{})}).map(([k,d])=>{const cfg=defActs[k]||d,s=streak(d.entries);return <div key={k} style={{display:'flex',alignItems:'center',padding:'12px',background:th.bgCard,borderRadius:'10px',gap:'12px'}}><span style={{fontSize:'20px'}}>{cfg.icon}</span><div style={{flex:1}}><div style={{fontSize:'13px',fontWeight:'600'}}>{cfg.name}</div><div style={{fontSize:'11px',color:th.textMut}}>{(d.entries||[]).length} entrÃ©es</div></div><div style={{fontSize:'13px',fontWeight:'600',color:th.success}}>{s}ğŸ”¥</div></div>;})}{Object.keys({...(modals.userProf.acts||{}),...(modals.userProf.customActs||{})}).length===0&&<p style={{fontSize:'13px',color:th.textMut,textAlign:'center',padding:'20px'}}>Aucune activitÃ©</p>}</div></div></div></div>}
    </div>
  );
}
